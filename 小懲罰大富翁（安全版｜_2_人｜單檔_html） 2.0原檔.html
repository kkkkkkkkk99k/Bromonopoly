<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>å°æ‡²ç½°å¤§å¯Œç¿</title>
  <style>
    :root{
      --bg:#0b1220; --card:#121826; --muted:#96a0b5; --line:#1f2937;
      --blue:#38bdf8; --pink:#f472b6; --green:#34d399; --amber:#f59e0b; --red:#fb7185;
    }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 800px at 70% 10%, #0f172a, #0b1220 60%, #08101b);color:#e5e7eb;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    .wrap{display:grid;grid-template-columns:minmax(280px,420px) 1fr;gap:16px;padding:16px;min-height:100dvh}
    .card{background:var(--card);border:1px solid #263143;border-radius:16px;padding:14px;box-shadow:0 10px 40px rgba(0,0,0,.35)}
    h1{font-size:40px;margin:0 0 8px}
    h2{font-size:24px;margin:14px 0 8px;color:#d1d5db}
    .grid{display:grid;gap:10px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .grid.cols-3{grid-template-columns:repeat(3,1fr)}
    .hint{font-size:18px;color:var(--muted)}

    /* Board */
    .board{display:grid;grid-template-columns:repeat(5,1fr);grid-template-rows:repeat(5,1fr);gap:4px;aspect-ratio:1/1;width:min(60vh,100%);margin:auto}
    .cell{border:1px solid var(--line);border-radius:10px;position:relative;display:flex;align-items:center;justify-content:center;color:#aab3c5;font-size:1ä¸Šåˆ 01:07 2025/8/142px}
    .cell .idx{position:absolute;left:20px;top:20px;opacity:.6;font-size:40px}
    .token{position:absolute;bottom:6px;right:6px;display:flex;gap:14px}
    .dot{width:40px;height:40px;border-radius:50%;border:8px solid rgba(0,0,0,.35);box-shadow:0 4px 8px rgba(0,0,0,.4)}
    .pA{background:var(--blue)}
    .pB{background:var(--pink)}

    /* Buttons */
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    button{all:unset;cursor:pointer;padding:10px 18px;border-radius:12px;border:1px solid #2a3849;font-weight:700;background:#182235}
    button:disabled{opacity:.45;cursor:not-allowed}
    .blue{background:linear-gradient(180deg,#40c7ff,#2aa0df);border:none;color:#05121b}
    .pink{background:linear-gradient(180deg,#ff89c3,#df66a4);border:none;color:#2a0e1f}
    .green{background:linear-gradient(180deg,#5fe3b2,#34d399);border:none;color:#062016}
    .ghost{background:#1b2437}

    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px dashed #2a3849;font-size:16px;color:#c9d3e7}
    .tag{font-size:11px;color:#9fb0c7;background:#1a2236;border:1px solid #2a3849;border-radius:999px;padding:4px 8px}

    /* Pools */
    .pool{display:grid;grid-template-columns:1fr;gap:6px;max-height:170px;overflow:auto;padding:8px;border:1px solid #223046;border-radius:12px;background:#101827}
    .pool label{display:flex;align-items:center;gap:8px;font-size:14px}
    .pool input{accent-color:#60a5fa}

    /* Log & task */
    .log{height:180px;overflow:auto;background:#0f1626;border:1px solid #223046;border-radius:12px;padding:10px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:16px}
    .task{background:#0e192a;border:2px solid #223046;border-radius:12px;padding:10px}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px}
    .modal .box{background:var(--card);border:1px solid #2a3849;border-radius:16px;max-width:520px;width:100%;padding:16px}

    @media (max-width:980px){
      .wrap{grid-template-columns:1fr}
      .board{width:100%}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- å·¦ï¼šè¨­å®š / æ§åˆ¶ -->
    <div class="card" id="setupCard">
      <h1>å“¥å“¥å¼Ÿå¼Ÿå¤§å¯Œç¿</h1>
      <div class="hint">é–‹å±€å‰è«‹å„è‡ªå¹«å°æ–¹å‹¾é¸çƒæ± å…§å®¹ã€‚é–‹å§‹éŠæˆ²å¾Œå³å¯è¼ªæµæ“²éª°ä¸¦æŠ½ä»»å‹™ï¼›å®Œæˆä»»å‹™æ‰èƒ½å‰é€²ã€‚</div>
      
      <h2>å„ªå‹è€…å°‡å¯ä»¥ç²å¾—å¤§ç§˜å¯¶!!!</h2>

      <!--<h2>æŠ½å¡æ–¹å¼</h2>-->
      <div class="row">
        <!--<label class="pill"><input type="radio" name="drawMode" value="self" checked> ç”±ç•¶å‰ç©å®¶å¾è‡ªå·±çš„å…©å€‹æ± æŠ½ï¼ˆå»ºè­°ï¼‰</label>
        <label class="pill"><input type="radio" name="drawMode" value="mix"> é›™æ–¹å„æŠ½ä¸€å€‹ï¼ˆå¯¦é©—ï¼‰</label> -->
      </div>

      <h2>å¼Ÿå¼Ÿçš„æ‡²ç½°</h2>
      <div class="grid cols-2">
        <div>
          <div class="hint">å‹¾é¸ã€Œæ•™è¨“é“å…·ã€</div>
          <div class="pool" id="broTools"></div>
        </div>
        <div>
          <div class="hint">å‹¾é¸ã€Œæ‡²ç½°æ•¸é‡ã€</div>
          <div class="pool" id="broCounts"></div>
        </div>
      </div>

      <h2>å“¥å“¥çš„æ„›è­·</h2>
      <div class="grid cols-2">
        <div>
          <div class="hint">å‹¾é¸ã€Œäº’å‹•è¡Œç‚ºã€</div>
          <div class="pool" id="sisActs"></div>
        </div>
        <div>
          <div class="hint">å‹¾é¸ã€Œè¦ªå¯†éƒ¨ä½ã€</div>
          <div class="pool" id="sisParts"></div>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="green" id="startBtn">é–‹å§‹éŠæˆ²</button>
        <span class="hint">é–‹å§‹å¾Œä»å¯åœ¨æš«åœæ™‚èª¿æ•´è¨­å®šã€‚</span>
      </div>
    </div>

    <!-- å³ï¼šæ£‹ç›¤ + æ§åˆ¶ -->
    <div class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="row">
          <span class="pill"><span class="dot pA"></span> å“¥å“¥</span>
          <span class="pill"><span class="dot pB"></span> å¼Ÿå¼Ÿ</span>
        </div>
        <div class="row">
          <button class="ghost" id="pauseBtn">æš«åœ/è¨­å®š</button>
          <button class="ghost" id="resetBtn">é‡ç½®</button>
        </div>
      </div>

      <div class="board" id="board"></div>

      <div class="grid cols-2" style="margin-top:12px">
        <div class="card" style="background:#0f1626">
          <h2>å›åˆæ§åˆ¶</h2>
          <div class="row" style="margin:6px 0 8px">
            <div class="pill">ç›®å‰ï¼š<b id="turnName">å“¥å“¥</b></div>
            <div class="pill">éª°å­ï¼š<b id="diceVal">â€”</b></div>
          </div>
          <div class="row">
            <button class="blue" id="rollA">å“¥å“¥æ“²éª° ğŸ²</button>
            <button class="pink" id="rollB">å¼Ÿå¼Ÿæ“²éª° ğŸ²</button>
            <button id="doneBtn" disabled>å®Œæˆä»»å‹™ âœ…</button>
            <button id="failBtn" disabled>ä»»å‹™å¤±æ•— âŒ</button> <!-- æ–°å¢æŒ‰éˆ• -->
          </div>
          <div class="task" id="taskBox">ç­‰å¾…æ“²éª°â€¦</div>
        </div>
        <div>
          <h2 style="margin-top:0">äº‹ä»¶ç´€éŒ„</h2>
          <div class="log" id="log"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- å‹åˆ©å¯¶ç®± -->
  <div class="modal" id="chestModal">
    <div class="box">
      <h2>ğŸ æ‡²ç½°å¯¶ç®±(è¼¸å®¶ä¹–ä¹–å—ç½°å§ï¼)</h2>
      <div id="chestContent" class="grid"></div>
      <div class="row" style="margin-top:10px;justify-content:flex-end">
        <button class="green" id="closeChest">è¦ä¸Šè¨´å°±é»å³ä¸Šè§’"é‡ç½®"</button>
      </div>
    </div>
  </div>

<script>
// ---------- è³‡æ–™ ----------
const DATA = {
  bro: { // å¼Ÿå¼Ÿï¼šé“å…· + æ•¸é‡
    tools: ["å¤§æ¿", "å°æ¿", "æ‰‹æŒ", "çš®å¸¶", "æ£å­", "è»Ÿæ‹", "æ¡Œçƒæ‹", "æˆ’å°º"],
    counts: ["60", "50", "40", "30", "20"],
  },
  sis: { // å“¥å“¥ï¼šäº’å‹• + éƒ¨ä½
    acts: ["æŒ‰å£“", "è¦ªå»", "èˆ”èˆ", "æ’«æ‘¸", "è¼•æ‹"],
    parts: ["è‡‰éƒ¨", "èƒ¸éƒ¨", "èƒŒéƒ¨", "è‡€éƒ¨", "è‚‰æ£’", "è‚‰ç©´"],
  },
};


// UI refs
const boardEl = document.getElementById('board');
const logEl = document.getElementById('log');
const taskBox = document.getElementById('taskBox');
const diceValEl = document.getElementById('diceVal');
const turnNameEl = document.getElementById('turnName');

const rollA = document.getElementById('rollA'); // å“¥å“¥
const rollB = document.getElementById('rollB'); // å¼Ÿå¼Ÿ
const doneBtn = document.getElementById('doneBtn');
const failBtn = document.getElementById('failBtn');
const startBtn = document.getElementById('startBtn');
const resetBtn = document.getElementById('resetBtn');
const pauseBtn = document.getElementById('pauseBtn');

// Pools containers
const broToolsEl = document.getElementById('broTools');
const broCountsEl = document.getElementById('broCounts');
const sisActsEl = document.getElementById('sisActs');
const sisPartsEl = document.getElementById('sisParts');

const chestModal = document.getElementById('chestModal');
const chestContent = document.getElementById('chestContent');
const closeChest = document.getElementById('closeChest');

// State
let drawMode = 'self'; // self | mix
let started = false;
const players = [
  { name: 'å“¥å“¥', pos: 0, key: 'sis' },
  { name: 'å¼Ÿå¼Ÿ', pos: 0, key: 'bro' },
];
let turn = 0; // 0: å“¥å“¥, 1: å¼Ÿå¼Ÿ
let mustComplete = false;
let lastRoll = 0;

// ---------- åˆå§‹åŒ– UI ----------
function makeCheckList(values, group, defaults = []){
  return values.map(v => {
    const id = `${group}-${v}`;
    const checked = defaults.includes(v) ? 'checked' : '';
    return `<label><input type="checkbox" data-group="${group}" value="${v}" ${checked}/> ${v}</label>`;
  }).join('');
}

function renderPools(){
  broToolsEl.innerHTML = makeCheckList(DATA.bro.tools, 'broTools', DATA.bro.tools.slice(0,5));
  broCountsEl.innerHTML = makeCheckList(DATA.bro.counts, 'broCounts', DATA.bro.counts);
  sisActsEl.innerHTML = makeCheckList(DATA.sis.acts, 'sisActs', DATA.sis.acts);
  sisPartsEl.innerHTML = makeCheckList(DATA.sis.parts, 'sisParts', DATA.sis.parts);
}

function getChecked(group){
  return Array.from(document.querySelectorAll(`input[data-group="${group}"]:checked`)).map(i=>i.value);
}

function $(sel){ return document.querySelector(sel); }

function log(msg){
  const time = new Date().toLocaleTimeString('zh-TW', { hour12:false });
  logEl.innerHTML = `[${time}] ${msg}<br>` + logEl.innerHTML;
}

function buildBoard(){
  boardEl.innerHTML = '';
  for(let i=1;i<=25;i++){
    const cell = document.createElement('div');
    cell.className = 'cell';
    cell.innerHTML = `<span class="idx">${i}</span>`;
    const token = document.createElement('div');
    token.className = 'token';
    if(i===1){
      token.innerHTML = `<span class="dot pA" title="å“¥å“¥"></span><span class="dot pB" title="å¼Ÿå¼Ÿ"></span>`;
    }
    cell.appendChild(token);
    boardEl.appendChild(cell);
  }
}

function updateTokens(){
  // Clear tokens
  document.querySelectorAll('.cell .token').forEach(t=>t.innerHTML='');
  // Place tokens
  players.forEach((p,idx)=>{
    const cellIdx = Math.min(24, p.pos) + 1; // 0..24 -> 1..25; pos==24 => cell 25
    const tokenEl = boardEl.children[cellIdx-1].querySelector('.token');
    const span = document.createElement('span');
    span.className = 'dot ' + (idx===0? 'pA':'pB');
    span.title = p.name;
    tokenEl.appendChild(span);
  });
}


function setTurn(t){
  turn = t;
  turnNameEl.textContent = players[turn].name;
  rollA.disabled = turn!==0 || mustComplete || !started;
  rollB.disabled = turn!==1 || mustComplete || !started;
  doneBtn.disabled = !mustComplete;
  failBtn.disabled = !mustComplete; // å¤±æ•—æŒ‰éˆ•åŒæ¨£åªåœ¨éœ€è¦å®Œæˆæ™‚å¯ç”¨
}

failBtn.addEventListener('click', failTask);

function randPick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

function currentPools(){
  const broTools = getChecked('broTools');
  const broCounts = getChecked('broCounts');
  const sisActs = getChecked('sisActs');
  const sisParts = getChecked('sisParts');
  return { broTools, broCounts, sisActs, sisParts };
}

function ensurePoolsOK(){
  const P = currentPools();
  const ok = P.broTools.length && P.broCounts.length && P.sisActs.length && P.sisParts.length;
  if(!ok){ alert('è«‹è‡³å°‘åœ¨æ¯å€‹å€å¡Šå‹¾é¸ 1 é …ï¼'); }
  return ok;
}

function makeTaskText(rollerIdx, drawVal){
  const P = currentPools();
  const me = players[rollerIdx];
  const other = players[1-rollerIdx];

  let text = '';

  if(me.key==='bro'){ 
    // å¼Ÿå¼Ÿï¼šåªç”¨å¼Ÿå¼Ÿçš„é“å…·+æ•¸é‡ï¼Œä¸æŠ½å“¥å“¥æ± 
    const tool = randPick(P.broTools);
    const count = randPick(P.broCounts);
    text = `${other.name} ç”¨ã€Œ${tool}ã€å° ${me.name} é€²è¡Œ ${count} æ¬¡æ•™è¨“ã€‚`;
  } else { 
    // å“¥å“¥ï¼šåªç”¨å“¥å“¥çš„äº’å‹•+éƒ¨ä½ï¼Œä¸æŠ½å¼Ÿå¼Ÿæ± 
    const act = randPick(P.sisActs);
    const part = randPick(P.sisParts);
    let times = 1;
    if(["æ“ŠæŒ","æ¡æ‰‹"].includes(act)) times = Math.ceil(Math.random()*5);
    text = `${me.name} å° ${other.name} çš„ã€Œ${part}ã€é€²è¡Œã€Œ${act}ã€${times} æ¬¡ã€‚`;
  }

  return text;
}


function rollDice(by){
  if(!started){ alert('è«‹å…ˆé–‹å§‹éŠæˆ²'); return; }
  if(!ensurePoolsOK()) return;
  if(by!==turn) { alert('é‚„æ²’è¼ªåˆ°ä½ å–”'); return; }
  const val = Math.floor(Math.random()*6)+1;
  lastRoll = val; diceValEl.textContent = val;
  const task = makeTaskText(by, val);
  taskBox.textContent = 'ä»»å‹™ï¼š' + task;
  log(`${players[by].name} æ“²å‡º ${val} é»ã€‚`);
  mustComplete = true; setTurn(turn); // é–å®šéœ€è¦å®Œæˆ
}

function completeTask(){
  if(!mustComplete) return;
  // å‰é€²
  players[turn].pos = Math.min(24, players[turn].pos + lastRoll);
  updateTokens();
  log(`${players[turn].name} å®Œæˆä»»å‹™ï¼Œå‰é€² ${lastRoll} æ ¼ï¼ˆåˆ°é”ç¬¬ ${players[turn].pos+1} æ ¼ï¼‰ã€‚`);
  mustComplete = false; diceValEl.textContent = 'â€”'; taskBox.textContent = 'ç­‰å¾…æ“²éª°â€¦';

  // å‹è² 
  if(players[turn].pos>=24){
    openChest(turn); // æœ¬å›åˆç©å®¶æŠµé” 25 å‹åˆ©
  } else {
    setTurn(1-turn);
  }
}

function failTask(){
  if(!mustComplete) return;
  log(`${players[turn].name} ä»»å‹™å¤±æ•—ï¼Œæœªå‰é€²ã€‚`);
  mustComplete = false; diceValEl.textContent = 'â€”'; taskBox.textContent = 'ç­‰å¾…æ“²éª°â€¦';
  setTurn(1-turn);
}

function openChest(winnerIdx){
  const winner = players[winnerIdx];
  const loser = players[1-winnerIdx];
  const P = currentPools();
  chestContent.innerHTML = '';

  let rewards = [];
  if(loser.key==='bro'){
    // è‹¥å¤±æ•—è€…æ˜¯å¼Ÿå¼Ÿï¼šå¾ã€Œå¼Ÿå¼Ÿçš„é“å…·+æ•¸é‡ã€ç”Ÿæˆ 3 é …ï¼Œéƒ¨ä½ç”¨å“¥å“¥çš„éƒ¨ä½æ± 
    for(let i=0;i<3;i++){
      const tool = randPick(P.broTools);
      const part = randPick(P.sisParts);
      rewards.push(`${winner.name} ç”¨ã€Œ${tool}ã€æ‰“ ${loser.name} ${part}`);
    }              
  }else{
    // è‹¥å¤±æ•—è€…æ˜¯å“¥å“¥ï¼šå¾ã€Œå“¥å“¥çš„äº’å‹•+éƒ¨ä½ã€ç”Ÿæˆ 3 é …
    for(let i=0;i<3;i++){
      const act = randPick(P.sisActs);
      const count = randPick(P.broCounts);
      const part = randPick(P.sisParts);
      const times = Math.ceil(Math.random()*3);
      rewards.push(` ${loser.name} è¦å°${winner.name} çš„${part} ${act} ${count} æ¬¡`);
    }
  }

  rewards.forEach(r=>{
    const div = document.createElement('div');
    div.className = 'task';
    div.textContent = 'å—ç½°é …ç›®ï¼š' + r + 'ã€‚';
    chestContent.appendChild(div);
  });

  chestModal.style.display = 'flex';
  log(`ğŸ‰ ${winner.name} æŠµé”ç¬¬ 25 æ ¼ï¼Œé–‹å•Ÿå¯¶ç®±ï¼å°‡å° ${loser.name} åŸ·è¡Œ 3 é …æ‡²ç½°ã€‚`);
}

closeChest.addEventListener('click', ()=>{
  chestModal.style.display = 'none';
});

// ---------- æ§åˆ¶ ----------
rollA.addEventListener('click', ()=>rollDice(0));
rollB.addEventListener('click', ()=>rollDice(1));

doneBtn.addEventListener('click', completeTask);

startBtn.addEventListener('click', ()=>{
  if(!ensurePoolsOK()) return;
  started = true; setTurn(0);
  $('#setupCard').style.opacity = .6; $('#setupCard').style.pointerEvents = 'none';
  log('éŠæˆ²é–‹å§‹ï¼ç”± å“¥å“¥ å…ˆæ‰‹ã€‚');
});

resetBtn.addEventListener('click', ()=>{
  players.forEach(p=>p.pos=0); updateTokens();
  mustComplete=false; setTurn(0); started=false; diceValEl.textContent='â€”'; taskBox.textContent='ç­‰å¾…æ“²éª°â€¦';
  $('#setupCard').style.opacity = 1; $('#setupCard').style.pointerEvents = 'auto';
  buildBoard(); updateTokens(); log('å·²é‡ç½®éŠæˆ²ã€‚');
});

pauseBtn.addEventListener('click', ()=>{
  const disabled = $('#setupCard').style.pointerEvents !== 'none';
  if(disabled){ // æ­£åœ¨å¯ç·¨è¼¯ -> æ”¹ç‚ºä¸å¯ç·¨è¼¯
    $('#setupCard').style.opacity = .6; $('#setupCard').style.pointerEvents = 'none';
  }else{
    $('#setupCard').style.opacity = 1; $('#setupCard').style.pointerEvents = 'auto';
  }
});

// æŠ½å¡æ–¹å¼åˆ‡æ›
Array.from(document.querySelectorAll('input[name="drawMode"]')).forEach(r=>{
  r.addEventListener('change', (e)=>{ drawMode = e.target.value; log('æŠ½å¡æ–¹å¼å·²åˆ‡æ›ç‚ºï¼š' + (drawMode==='self'?'è‡ªå·±é›™æ± ':'é›™æ–¹å„ä¸€')); });
});

// åˆå§‹
renderPools();
buildBoard();
updateTokens();
setTurn(0);
</script>
</body>
</html>
